# ============================================================================
# Solana Monitor â€” Scheduled wallet & token price monitoring
# MODULAR PLUGIN: Only runs when Solana monitoring is enabled.
# ============================================================================
name: "ðŸ“¡ Solana Monitor"

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      force:
        description: "Run even if monitoring is disabled"
        required: false
        default: "false"
        type: string

permissions:
  issues: write
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Solana monitoring is enabled
        id: check
        run: |
          source scripts/solana-tools.sh
          FORCE="${{ inputs.force || 'false' }}"
          if check_solana_enabled || [ "$FORCE" = "true" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Solana monitoring not enabled. Skipping."
          fi

      - name: Set up Python
        if: steps.check.outputs.enabled == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Parse wallet config
        if: steps.check.outputs.enabled == 'true'
        id: config
        run: |
          # Extract wallet addresses from agent.md
          WALLETS="[]"
          if [ -f agent.md ]; then
            WALLETS=$(grep -oP 'solana-wallet:\s*\K.*' agent.md 2>/dev/null | \
              while IFS= read -r line; do
                ADDR=$(echo "$line" | awk '{print $1}')
                LABEL=$(echo "$line" | sed 's/^[^ ]* *//' | tr -d '()')
                echo "{\"address\": \"$ADDR\", \"label\": \"${LABEL:-$ADDR}\"}"
              done | jq -s '.' 2>/dev/null || echo "[]")
          fi
          echo "wallets=$WALLETS" >> "$GITHUB_OUTPUT"

          # Extract watchlist tokens
          TOKENS="SOL"
          if [ -f agent.md ]; then
            CUSTOM=$(grep -oP 'solana-watch:\s*\K\w+' agent.md 2>/dev/null | paste -sd ',' || echo "")
            if [ -n "$CUSTOM" ]; then
              TOKENS="$CUSTOM"
            fi
          fi
          echo "tokens=$TOKENS" >> "$GITHUB_OUTPUT"

      - name: Find or create monitor issue
        if: steps.check.outputs.enabled == 'true'
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure the label exists
          gh label create "solana:monitor" --description "ðŸ“¡ Solana monitor" --color "9945FF" 2>/dev/null || true

          EXISTING=$(gh issue list --label "solana:monitor" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "number=$EXISTING" >> "$GITHUB_OUTPUT"
          else
            URL=$(gh issue create \
              --title "ðŸ“¡ Solana Monitor â€” Active" \
              --body "Solana monitoring reports will appear here as comments.")
            NUMBER=$(echo "$URL" | grep -o '[0-9]*$')
            gh issue edit "$NUMBER" --add-label "solana:monitor"
            echo "number=$NUMBER" >> "$GITHUB_OUTPUT"
          fi

      - name: Run monitor
        if: steps.check.outputs.enabled == 'true'
        working-directory: agents
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          SOLANA_WALLETS: ${{ steps.config.outputs.wallets }}
          SOLANA_WATCHLIST: ${{ steps.config.outputs.tokens }}
          SOLANA_NETWORK: ${{ vars.SOLANA_NETWORK || 'mainnet-beta' }}
          SOLANA_RPC_URL: ${{ secrets.SOLANA_RPC_URL || '' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 solana_monitor.py

      - name: Persist
        if: steps.check.outputs.enabled == 'true'
        run: |
          source scripts/git-persist.sh
          persist_many "ðŸ“¡ Solana monitoring sweep" \
            "memory/solana/" "memory/state.json"
