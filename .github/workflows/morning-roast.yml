# ============================================================================
# Morning Roast — GitClaw's daily briefing with extra sass
# Runs every weekday morning, summarizes open issues with coffee metaphors.
# ============================================================================
name: "☕ Morning Roast"

on:
  schedule:
    - cron: '0 9 * * 1-5'  # 9 AM UTC, Mon-Fri
  workflow_dispatch:        # Manual trigger for testing

permissions:
  issues: write
  contents: write

jobs:
  brew:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Gather context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get open issues
          ISSUES=$(gh issue list --state open --json number,title,labels,createdAt --limit 20)
          echo "issues<<EOF" >> "$GITHUB_OUTPUT"
          echo "$ISSUES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # Get recent activity
          ACTIVITY=$(gh api repos/${{ github.repository }}/events --jq '.[0:10] | map({type, actor: .actor.login, created_at: .created_at})')
          echo "activity<<EOF" >> "$GITHUB_OUTPUT"
          echo "$ACTIVITY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # Get agent state
          STATE=$(cat memory/state.json 2>/dev/null || echo '{}')
          echo "state<<EOF" >> "$GITHUB_OUTPUT"
          echo "$STATE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Brew the roast
        id: roast
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CTX_ISSUES: ${{ steps.context.outputs.issues }}
          CTX_ACTIVITY: ${{ steps.context.outputs.activity }}
          CTX_STATE: ${{ steps.context.outputs.state }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/morning-roast.md)

          # Build user message with context
          USER_MSG=$(cat <<MSG
          Today's date: $(today)
          Greeting: $(time_greeting)

          Open Issues:
          $CTX_ISSUES

          Recent Activity:
          $CTX_ACTIVITY

          Agent State:
          $CTX_STATE

          Generate the Morning Roast briefing now.
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-haiku-4-5-20251001}"

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 1500)

          # Save response for next step
          echo "response<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Find or create daily roast issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date -u +"%Y-%m-%d")

          # Ensure the label exists (create it if missing)
          gh label create "gitclaw:roast" --description "☕ Morning roast target" --color "6f4e37" 2>/dev/null || true

          # Look for existing daily roast issue
          EXISTING=$(gh issue list --label "gitclaw:roast" --state open --json number --jq ".[0].number // empty")

          if [ -n "$EXISTING" ]; then
            echo "issue_number=$EXISTING" >> "$GITHUB_OUTPUT"
          else
            # Create new daily roast issue then add the label
            URL=$(gh issue create \
              --title "☕ Morning Roast — $TODAY" \
              --body "Daily briefing thread. GitClaw's Morning Roast will appear as a comment below.")
            NUMBER=$(echo "$URL" | grep -o '[0-9]*$')
            gh issue edit "$NUMBER" --add-label "gitclaw:roast"
            echo "issue_number=$NUMBER" >> "$GITHUB_OUTPUT"
          fi

      - name: Serve the roast
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ROAST_BODY: ${{ steps.roast.outputs.response }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.issue_number }}/comments \
            -f body="$ROAST_BODY"

      - name: Archive roast
        env:
          ROAST_CONTENT: ${{ steps.roast.outputs.response }}
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          mkdir -p memory/roasts
          printf '%s\n' "$ROAST_CONTENT" > "memory/roasts/$TODAY.md"

      - name: Persist to memory
        run: |
          source scripts/git-persist.sh
          persist_many "☕ Morning Roast — $(today)" "memory/roasts/$(today).md" "memory/state.json"
