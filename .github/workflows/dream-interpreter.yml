# ============================================================================
# Dream Interpreter â€” Personal journaling with mystical interpretations
# Triggered by /dream command via command-router.
# ============================================================================
name: "ðŸŒ™ Dream Interpreter"

on:
  workflow_call:
    inputs:
      description:
        required: true
        type: string
      issue_number:
        required: true
        type: number
  workflow_dispatch:
    inputs:
      description:
        description: "Describe your dream"
        required: true
        type: string
      issue_number:
        description: "Issue number to post to"
        required: false
        default: "0"
        type: string

permissions:
  issues: write
  contents: write

jobs:
  interpret:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check dream history
        id: history
        run: |
          PREVIOUS=""
          if [ -d memory/dreams ]; then
            for f in $(ls -t memory/dreams/*.md 2>/dev/null | head -3); do
              TITLE=$(head -1 "$f" | sed 's/^#* *//')
              PREVIOUS="$PREVIOUS\n- $TITLE"
            done
          fi
          echo "previous<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$PREVIOUS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Interpret the dream
        id: interpretation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/dream-interpreter.md)

          USER_MSG=$(cat <<MSG
          Dream to interpret:
          ${{ inputs.description }}

          Previous dreams for pattern tracking:
          ${{ steps.history.outputs.previous }}

          Interpret this dream now.
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-sonnet-4-5-20250929}"

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 1200)

          echo "response<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post and archive
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ inputs.issue_number }}"
          TODAY=$(date -u +"%Y-%m-%d")

          # Post interpretation
          if [ "$ISSUE" != "0" ] && [ -n "$ISSUE" ]; then
            gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
              -f body='${{ steps.interpretation.outputs.response }}'
          fi

          # Archive dream
          mkdir -p memory/dreams
          cat <<'DREAM' > "memory/dreams/${TODAY}.md"
          ${{ steps.interpretation.outputs.response }}
          DREAM

      - name: Persist
        run: |
          source scripts/git-persist.sh
          update_state '.stats.dreams_interpreted += 1 | .xp += 5'
          persist_many "ðŸŒ™ Dream interpreted" \
            "memory/dreams/" "memory/state.json"
