# ============================================================================
# Meme Machine â€” Content generation via manual dispatch
# Generate viral content ideas, tweet threads, blog outlines.
# ============================================================================
name: "ðŸŽ¨ Meme Machine"

on:
  workflow_dispatch:
    inputs:
      content_type:
        description: "Content type"
        required: true
        type: choice
        options:
          - tweet_thread
          - blog_outline
          - meme_concepts
          - content_calendar
      topic:
        description: "Topic / subject matter"
        required: true
        type: string
      tone:
        description: "Tone"
        required: false
        type: choice
        default: "funny"
        options:
          - funny
          - professional
          - provocative
          - educational
      platform:
        description: "Target platform"
        required: false
        type: choice
        default: "twitter"
        options:
          - twitter
          - linkedin
          - reddit
          - general

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fire up the machine
        id: content
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INPUT_TYPE: ${{ inputs.content_type }}
          INPUT_TOPIC: ${{ inputs.topic }}
          INPUT_TONE: ${{ inputs.tone }}
          INPUT_PLATFORM: ${{ inputs.platform }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/meme-machine.md)

          USER_MSG=$(cat <<MSG
          Generate content:
          - Type: $INPUT_TYPE
          - Topic: $INPUT_TOPIC
          - Tone: $INPUT_TONE
          - Platform: $INPUT_PLATFORM

          Create the content now. Make it genuinely good enough to post.
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-haiku-4-5-20251001}"

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 2000)

          echo "content<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Save content
        env:
          CONTENT_BODY: ${{ steps.content.outputs.content }}
          INPUT_TOPIC: ${{ inputs.topic }}
          INPUT_TYPE: ${{ inputs.content_type }}
          INPUT_TONE: ${{ inputs.tone }}
          INPUT_PLATFORM: ${{ inputs.platform }}
        run: |
          SLUG=$(echo "$INPUT_TOPIC" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-' | head -c 50)
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          mkdir -p memory/content

          {
            echo "# ðŸŽ¨ Content: $INPUT_TOPIC"
            echo "_Generated on $(date -u +"%Y-%m-%d %H:%M UTC")_"
            echo "_Type: $INPUT_TYPE | Tone: $INPUT_TONE | Platform: $INPUT_PLATFORM_"
            echo ""
            echo "---"
            echo ""
            printf '%s\n' "$CONTENT_BODY"
          } > "memory/content/${TIMESTAMP}-${SLUG}.md"

      - name: Persist
        env:
          INPUT_TOPIC: ${{ inputs.topic }}
        run: |
          source scripts/git-persist.sh
          persist_many "ðŸŽ¨ Content generated: $INPUT_TOPIC" \
            "memory/content/" "memory/state.json"

      - name: Summary
        env:
          CONTENT_OUTPUT: ${{ steps.content.outputs.content }}
        run: |
          echo "### ðŸŽ¨ Meme Machine Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$CONTENT_OUTPUT" >> $GITHUB_STEP_SUMMARY
