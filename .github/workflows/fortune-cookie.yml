# ============================================================================
# Fortune Cookie â€” Daily coding wisdom and motivational nonsense
# Runs every morning, delivers cryptic programming fortunes.
# ============================================================================
name: "ðŸ”® Fortune Cookie"

on:
  schedule:
    - cron: '0 8 * * *'  # 8 AM UTC daily
  workflow_dispatch:

permissions:
  issues: write
  contents: write

jobs:
  fortune:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check fortune history
        id: history
        run: |
          MONTH=$(date -u +"%Y-%m")
          RECENT=""
          if [ -f "memory/fortunes/${MONTH}.md" ]; then
            RECENT=$(tail -20 "memory/fortunes/${MONTH}.md" 2>/dev/null || echo "")
          fi
          echo "recent<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RECENT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          STATE=$(cat memory/state.json 2>/dev/null || echo '{}')
          echo "state<<EOF" >> "$GITHUB_OUTPUT"
          echo "$STATE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Crack open the cookie
        id: fortune
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HIST_RECENT: ${{ steps.history.outputs.recent }}
          HIST_STATE: ${{ steps.history.outputs.state }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/fortune-cookie.md)

          USER_MSG=$(cat <<MSG
          Date: $(today)
          Day of week: $(date -u +"%A")

          Recent fortunes (avoid repeating):
          $HIST_RECENT

          Agent state:
          $HIST_STATE

          Generate today's fortune cookie.
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-haiku-4-5-20251001}"  # Fortunes use cheaper model

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 800)

          echo "fortune<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Find or create fortune issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MONTH=$(date -u +"%B %Y")

          # Ensure the label exists
          gh label create "gitclaw:fortune" --description "ðŸ”® Fortune cookie" --color "bf5700" 2>/dev/null || true

          EXISTING=$(gh issue list --label "gitclaw:fortune" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "number=$EXISTING" >> "$GITHUB_OUTPUT"
          else
            URL=$(gh issue create \
              --title "ðŸ”® Fortune Cookies â€” $MONTH" \
              --body "Your daily coding fortunes appear here. The cookie has spoken.")
            NUMBER=$(echo "$URL" | grep -o '[0-9]*$')
            gh issue edit "$NUMBER" --add-label "gitclaw:fortune"
            echo "number=$NUMBER" >> "$GITHUB_OUTPUT"
          fi

      - name: Deliver the fortune
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORTUNE_BODY: ${{ steps.fortune.outputs.fortune }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/comments \
            -f body="$FORTUNE_BODY"

      - name: Archive fortune
        env:
          FORTUNE_CONTENT: ${{ steps.fortune.outputs.fortune }}
        run: |
          MONTH=$(date -u +"%Y-%m")
          TODAY=$(date -u +"%Y-%m-%d")
          mkdir -p memory/fortunes

          {
            echo ""
            echo "---"
            echo "### $TODAY"
            echo ""
            printf '%s\n' "$FORTUNE_CONTENT"
          } >> "memory/fortunes/${MONTH}.md"

      - name: Persist
        run: |
          source scripts/git-persist.sh
          update_state '.stats.fortunes_dispensed += 1 | .xp += 2'
          persist_many "ðŸ”® Fortune: $(today)" \
            "memory/fortunes/" "memory/state.json"
