# ============================================================================
# Wild Fact Finder ‚Äî Research agent triggered by /research command
# Callable from command-router or directly via workflow_dispatch.
# ============================================================================
name: "üîç Wild Fact Finder"

on:
  workflow_call:
    inputs:
      topic:
        required: true
        type: string
      issue_number:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      topic:
        description: "Topic to research"
        required: true
        type: string
      issue_number:
        description: "Issue number to post results to (0 = create new)"
        required: false
        default: "0"
        type: string

permissions:
  issues: write
  contents: write

jobs:
  research:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Research the topic
        id: research
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INPUT_TOPIC: ${{ inputs.topic }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/wild-fact-finder.md)

          USER_MSG=$(cat <<MSG
          Research topic: $INPUT_TOPIC

          Provide a thorough, entertaining research brief on this topic.
          Include key findings, a wild card fact, a fun tangent, and a tech connection.
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-haiku-4-5-20251001}"

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 1500)

          echo "response<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post findings
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESEARCH_BODY: ${{ steps.research.outputs.response }}
          INPUT_TOPIC: ${{ inputs.topic }}
          ISSUE_NUM: ${{ inputs.issue_number }}
        run: |
          ISSUE="$ISSUE_NUM"

          if [ "$ISSUE" = "0" ] || [ -z "$ISSUE" ]; then
            # Ensure the label exists
            gh label create "gitclaw:research" --description "üîç Research request" --color "1f6feb" 2>/dev/null || true

            # Create a new issue for the research then label it
            URL=$(gh issue create \
              --title "üîç Research: $INPUT_TOPIC" \
              --body "$RESEARCH_BODY")
            NUMBER=$(echo "$URL" | grep -o '[0-9]*$')
            gh issue edit "$NUMBER" --add-label "gitclaw:research"
          else
            # Post as comment on existing issue
            gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
              -f body="$RESEARCH_BODY"
          fi

      - name: Archive research
        env:
          RESEARCH_CONTENT: ${{ steps.research.outputs.response }}
          INPUT_TOPIC: ${{ inputs.topic }}
        run: |
          SLUG=$(echo "$INPUT_TOPIC" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-' | head -c 50)
          mkdir -p memory/research
          {
            echo "# Research: $INPUT_TOPIC"
            echo "_Researched on $(date -u +"%Y-%m-%d %H:%M UTC")_"
            echo ""
            printf '%s\n' "$RESEARCH_CONTENT"
          } > "memory/research/$(date -u +%Y-%m-%d)-${SLUG}.md"

      - name: Persist
        env:
          INPUT_TOPIC: ${{ inputs.topic }}
        run: |
          source scripts/git-persist.sh
          update_state '.stats.researches_completed += 1 | .xp += 15'
          persist_many "üîç Research: $INPUT_TOPIC" \
            "memory/research/" "memory/state.json"
