# ============================================================================
# Hype Man â€” Celebrates closed issues and merged PRs
# Because every victory deserves confetti.
# ============================================================================
name: "ðŸŽ‰ Hype Man"

on:
  issues:
    types: [closed]
  pull_request:
    types: [closed]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  celebrate:
    runs-on: ubuntu-latest
    # Only celebrate if PR was actually merged (not just closed)
    if: >
      github.event_name == 'issues' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read state
        id: state
        run: |
          STATE=$(cat memory/state.json 2>/dev/null || echo '{}')
          echo "state<<EOF" >> "$GITHUB_OUTPUT"
          echo "$STATE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Generate celebration
        id: hype
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_USER: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_USER: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AGENT_STATE: ${{ steps.state.outputs.state }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/hype-man.md)

          if [ "$EVENT_NAME" = "issues" ]; then
            EVENT_TYPE="issue_closed"
            TITLE="$ISSUE_TITLE"
            CONTRIBUTOR="$ISSUE_USER"
            NUMBER="$ISSUE_NUMBER"
          else
            EVENT_TYPE="pr_merged"
            TITLE="$PR_TITLE"
            CONTRIBUTOR="$PR_USER"
            NUMBER="$PR_NUMBER"
          fi

          USER_MSG=$(cat <<MSG
          Event: $EVENT_TYPE
          Title: $TITLE
          Contributor: @$CONTRIBUTOR
          Number: #$NUMBER

          Agent State:
          $AGENT_STATE

          Generate a celebration worthy of this achievement!
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-haiku-4-5-20251001}"  # Quick celebrations

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 1000)

          echo "hype<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post celebration
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HYPE_BODY: ${{ steps.hype.outputs.hype }}
        run: |
          if [ "$EVENT_NAME" = "issues" ]; then
            NUMBER="$ISSUE_NUMBER"
          else
            NUMBER="$PR_NUMBER"
          fi

          gh api repos/${{ github.repository }}/issues/$NUMBER/comments \
            -f body="$HYPE_BODY"

      - name: Update XP
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          source scripts/git-persist.sh

          if [ "$EVENT_NAME" = "issues" ]; then
            update_state '.stats.issues_triaged += 1 | .xp += 10'
          else
            update_state '.stats.prs_reviewed += 1 | .xp += 25'
          fi

          # Update level
          XP=$(jq '.xp' memory/state.json)
          source scripts/utils.sh
          LEVEL=$(get_level "$XP")
          jq --arg level "$LEVEL" '.level = $level' memory/state.json > tmp.json && mv tmp.json memory/state.json

          persist "memory/state.json" "ðŸŽ‰ Celebration! XP awarded"
