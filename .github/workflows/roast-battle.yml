# ============================================================================
# Roast Battle â€” On-demand code roasting
# Triggered by /roast command. Delivers brutal but constructive feedback.
# ============================================================================
name: "ðŸ”¥ Roast Battle"

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      issue_number:
        required: true
        type: number
  workflow_dispatch:
    inputs:
      target:
        description: "File path or topic to roast"
        required: true
        type: string
      issue_number:
        description: "Issue number to post to"
        required: false
        default: "0"
        type: string

permissions:
  issues: write
  contents: write

jobs:
  roast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Gather roast material
        id: material
        run: |
          TARGET="${{ inputs.target }}"
          CODE_CONTENT=""

          # Check if the target is a file path
          if [ -f "$TARGET" ]; then
            CODE_CONTENT=$(head -100 "$TARGET" 2>/dev/null || echo "File not readable")
            echo "is_file=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_file=false" >> "$GITHUB_OUTPUT"
          fi

          echo "code<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CODE_CONTENT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Fire up the roast
        id: roast
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          source scripts/utils.sh
          source scripts/llm.sh

          SYSTEM_PROMPT=$(cat templates/prompts/roast-battle.md)

          USER_MSG=$(cat <<MSG
          Roast target: ${{ inputs.target }}

          Is it a file? ${{ steps.material.outputs.is_file }}

          Code content (if file):
          ${{ steps.material.outputs.code }}

          Roast requested by: ${{ github.actor }}

          Deliver the roast!
          MSG
          )

          PROVIDER="${GITCLAW_PROVIDER:-anthropic}"
          MODEL="${GITCLAW_MODEL:-claude-sonnet-4-5-20250929}"

          RESPONSE=$(call_llm "$PROVIDER" "$MODEL" "$SYSTEM_PROMPT" "$USER_MSG" 1500)

          echo "roast<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Deliver the roast
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ inputs.issue_number }}"

          if [ "$ISSUE" != "0" ] && [ -n "$ISSUE" ]; then
            gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
              -f body='${{ steps.roast.outputs.roast }}'
          fi

      - name: Archive and persist
        run: |
          source scripts/git-persist.sh
          update_state '.stats.roasts_delivered += 1 | .xp += 10'

          SLUG=$(echo "${{ inputs.target }}" | tr '[:upper:]' '[:lower:]' | tr ' /' '-' | tr -cd 'a-z0-9-' | head -c 50)
          mkdir -p memory/roasts
          echo '${{ steps.roast.outputs.roast }}' > "memory/roasts/$(date -u +%Y-%m-%d)-roast-${SLUG}.md"

          persist_many "ðŸ”¥ Roast delivered: ${{ inputs.target }}" \
            "memory/roasts/" "memory/state.json"
